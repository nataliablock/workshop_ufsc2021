<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Workshop 3 - 9 de fevereiro</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Workshop Introdução ao R - UFSC</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
<li>
  <a href="preparacao.html">Instruções para o Workshop</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Workshops
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="workshop1.html">Workshop 1</a>
    </li>
    <li>
      <a href="workshop2.html">Workshop 2</a>
    </li>
    <li>
      <a href="workshop3.html">Workshop 3</a>
    </li>
    <li>
      <a href="workshop4.html">Workshop 4</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://github.com/nataliablock/workshop_ufsc2021">Repositório</a>
</li>
<li>
  <a href="https://nataliablock.github.io/ufsc_dashboard/">Dashboard</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://twitter.com/nataliamblock">
    <span class="fab fa-twitter"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Workshop 3 - 9 de fevereiro</h1>

</div>


<div id="manipulação-de-dados-com-tidyr-e-elaboração-de-gráficos-com-ggplot2" class="section level1">
<h1>Manipulação de dados com tidyr e elaboração de gráficos com ggplot2</h1>
<div id="manipulação-de-dados-com-tidyr" class="section level2">
<h2>Manipulação de dados com tidyr</h2>
<p>Antes de tudo, vou apontar o R para meu diretório, fazer o upload dos bancos que vamos usar e das tabelas que trabalharemos</p>
<pre class="r"><code>#Apontando o R para meu diretório
setwd(&quot;~/Dropbox/repositories/workshop_ufsc2021&quot;)

#upload de pacotes
library(tidyverse)
library(readxl)

#upload de bancos

#banco de migracao
migracao&lt;-read_csv(&quot;dados/migracao_completo.csv&quot;)

#banco criado na atividade 2: migracao_alemanha
migracao_alemanha&lt;-read_csv(&quot;dados/migracao_alemanha.csv&quot;)

# banco criado na atividade 2: migracao_sexo
migracao_sexo&lt;-read_csv(&quot;dados/migracao_sexo.csv&quot;)

#banco de exportacao
exportacao&lt;-read_excel(&quot;dados/export_sc.xlsx&quot;)</code></pre>
<p>Como comentei no workshop anterior, o pacote tidyr (incluso no tidyverse) nos permite remodelar a estrutura da tabela, transformando linhas em colunas e vice-versa. Por vezes nossas tabelas precisam ser reestruturadas por causa do tipo de gráfico que queremos elaborar ou da forma como determinada função exige que os dados sejam apresentados.</p>
<p>As tabelas podem ser estruturadas de duas formas, em formato long, que em português costumamos chamar de painel, ou no formato wide. O formato painel apresenta todos os valores observados das variáveis para a unidade de análise nas linhas da tabela, enquanto no formato wide os valores observados para cada unidade de análise se encontram organizados em colunas separadas.</p>
<p>Vamos primeiro entender qual é a nossa unidade de análise. Para o nosso caso, estamos analisando os valores de migração, exportação e importação de Santa Catarina <strong>por país e ano</strong>. <strong>País e ano são nossas unidades de análise</strong>. Desta forma, se os valores de uma tabela forem apresentados <strong>por país e por ano nas linhas a tabela terá um formato long</strong>. Se elas forem apresentadas com <strong>país na linha e ano na coluna, ou ano na linha e e país na coluna a tabela terá o formato wide</strong>.</p>
<p>No caso das nossas tabelas, a tabela de migração apresenta formato de painel (long). Repare que para cada caso de nosso banco os países e anos estão nas linhas.</p>
<pre class="r"><code>migracao</code></pre>
<pre><code>## # A tibble: 826,375 x 7
##       X1 DATA_REG   CLASSIFICACAO UFRES PNASC_DESC          SEXO_DESCRICAO   ano
##    &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;         &lt;chr&gt; &lt;chr&gt;               &lt;chr&gt;          &lt;dbl&gt;
##  1     1 04/01/2010 PERMANENTE    SP    ITALIA              Masculino       2010
##  2     2 04/01/2010 PERMANENTE    AM    BELGICA             Feminino        2010
##  3     3 04/01/2010 PERMANENTE    RJ    ITALIA              Masculino       2010
##  4     4 04/01/2010 PERMANENTE    PR    COSTA RICA          Masculino       2010
##  5     5 04/01/2010 PERMANENTE    AP    GUINE BISSAU        Feminino        2010
##  6     6 04/01/2010 PERMANENTE    RJ    REPUBLICA POPULAR … Masculino       2010
##  7     7 04/01/2010 PERMANENTE    RS    MEXICO              Masculino       2010
##  8     8 04/01/2010 PERMANENTE    PR    SUICA               Masculino       2010
##  9     9 04/01/2010 PERMANENTE    SP    REPUBLICA POPULAR … Feminino        2010
## 10    10 04/01/2010 PERMANENTE    RJ    ESTADOS UNIDOS DA … Masculino       2010
## # … with 826,365 more rows</code></pre>
<p>Por sua vez, nossas tabelas de exportação e importação estão no formato wide pois os países estão na linha e os anos estão nas colunas, ou seja, as colunas apresentam os valores de exportação e importação para cada ano.</p>
<pre class="r"><code>exportacao</code></pre>
<pre><code>## # A tibble: 232 x 12
##    `UF do Municípi… País  `2019 - Valor F… `2018 - Valor F… `2017 - Valor F…
##    &lt;chr&gt;            &lt;chr&gt;            &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;
##  1 Santa Catarina   China       1589499886       3508475541       1387040317
##  2 Santa Catarina   Esta…       1440141803       1491866039       1550676302
##  3 Santa Catarina   Japão        561745487        536371415        646116312
##  4 Santa Catarina   Arge…        447748671        552792985        600795239
##  5 Santa Catarina   Méxi…        378975807        342542623        370202508
##  6 Santa Catarina   Aráb…        378497673        385196450        415060832
##  7 Santa Catarina   Chile        319902112        284802121        296522108
##  8 Santa Catarina   Emir…        288968147        266484776        250951898
##  9 Santa Catarina   Hong…        264453882        297468554        298270270
## 10 Santa Catarina   Rein…        260757521        257047712        331852429
## # … with 222 more rows, and 7 more variables: `2016 - Valor FOB (US$)` &lt;dbl&gt;,
## #   `2015 - Valor FOB (US$)` &lt;dbl&gt;, `2014 - Valor FOB (US$)` &lt;dbl&gt;, `2013 -
## #   Valor FOB (US$)` &lt;dbl&gt;, `2012 - Valor FOB (US$)` &lt;dbl&gt;, `2011 - Valor FOB
## #   (US$)` &lt;dbl&gt;, `2010 - Valor FOB (US$)` &lt;dbl&gt;</code></pre>
<p>No entanto, para elaborarmos os gráficos iguais aos do dashboard teremos que alterar a estrutura dessas tabelas. Para criarmos um gráfico de linha de exportação a tabela precisa estar em formato long, enquanto para montarmos um gráfico do tipo dumbbell para migração de mulheres e homens precisamos do dados organizados em formato wide.</p>
</div>
<div id="transformando-tabela-wide-para-long-limpando-a-tabela-exportação" class="section level2">
<h2>Transformando tabela wide para long: limpando a tabela exportação</h2>
<p>Para alterar o formato da nossa tabela <code>exportacao</code> usaremos a função <code>pivot_longer</code> do <code>tidyr</code>. Ela recebe como argumentos os seguintes parâmetros:</p>
<ul>
<li><p><code>cols</code>= colunas que se transformarão do formato wide para long. Podemos utilizar <code>:</code> se as colunas a serem reformatadas estão em uma área específica do dataframe, ou podemos criar um vetor, utilizando a função <code>c()</code> que vimos no workshop 2, com os nomes das colunas que iremos alterar. No caso da tabela migração as colunas estão todas em uma área específica, então iremos usar a primeira opção.</p></li>
<li><p><code>names_to</code>= será a nova coluna criada a partir dos nomes das colunas. Insira neste argumento o nome que esta nova coluna receberá na forma de string, ou seja, entre aspas. No nosso exemplo daremos o nome de <code>ano_bruto</code>. Escolhi esse nome porque a seguir criaremos outra coluna apenas com os anos a partir desta.</p></li>
<li><p><code>values_to</code>= será a nova coluna que receberá os valores que serão colapsados no formato long a partir das antigas colunas. Colocaremos aí o nome desta nova coluna em formato string, que será <code>valor</code>.</p></li>
</ul>
<p>Salvarei essa transformação no objeto <code>exportacao</code> pois este será o formato final do nosso banco. Estamos subscrevendo o banco anterior, salvando, assim, espaço em memória.</p>
<pre class="r"><code>exportacao&lt;- exportacao%&gt;%
  pivot_longer(cols=`2019 - Valor FOB (US$)`:`2010 - Valor FOB (US$)`,
               names_to = &quot;ano_bruto&quot;,
               values_to = &quot;valor&quot;)

exportacao</code></pre>
<pre><code>## # A tibble: 2,320 x 4
##    `UF do Município` País  ano_bruto                   valor
##    &lt;chr&gt;             &lt;chr&gt; &lt;chr&gt;                       &lt;dbl&gt;
##  1 Santa Catarina    China 2019 - Valor FOB (US$) 1589499886
##  2 Santa Catarina    China 2018 - Valor FOB (US$) 3508475541
##  3 Santa Catarina    China 2017 - Valor FOB (US$) 1387040317
##  4 Santa Catarina    China 2016 - Valor FOB (US$) 1096838348
##  5 Santa Catarina    China 2015 - Valor FOB (US$)  829695943
##  6 Santa Catarina    China 2014 - Valor FOB (US$) 1149980960
##  7 Santa Catarina    China 2013 - Valor FOB (US$)  999306427
##  8 Santa Catarina    China 2012 - Valor FOB (US$)  900878336
##  9 Santa Catarina    China 2011 - Valor FOB (US$)  706020312
## 10 Santa Catarina    China 2010 - Valor FOB (US$)  427097677
## # … with 2,310 more rows</code></pre>
<p>Veja no dashboard que para criar um gráfico de linhas precisaremos dos valores de cada país por ano. Dessa forma, temos que criar uma coluna apenas com os anos. Para isso utilizaremos o pacote <code>stringr</code>, que faz parte do <code>tidyverse</code>, para retirarmos apenas os anos da coluna <code>ano_bruto</code> e salvarmos em uma nova coluna que chamarei de <code>ano</code>.</p>
<p>Não veremos o <code>stringr</code> com detalhes neste workshop. Resumidamente, esse pacote possui funções para a manipulação de strings, ou seja, palavras. Deste pacote, utilizaremos a função <code>substr</code>, de “substract” que irá retirar da coluna <code>ano_bruto</code> os elementos que incluiremos nos argumentos <code>start</code> e <code>stop</code>. Queremos retirar os quatro primeiros elementos da string que nos dão os anos. Assim, <code>start</code> recebe 1 e <code>stop</code> recebe 4. Vamos salvar o resultado em uma nova variável chamada <code>ano</code>. Para isso estamos usando o <code>$</code> para acessar uma coluna na tabela, como vimos no workshop passado, e escrevemos o nome da nova coluna logo depois do símbolo.</p>
<pre class="r"><code>exportacao$ano&lt;-substr(exportacao$ano_bruto, start=1, stop=4)

exportacao</code></pre>
<pre><code>## # A tibble: 2,320 x 5
##    `UF do Município` País  ano_bruto                   valor ano  
##    &lt;chr&gt;             &lt;chr&gt; &lt;chr&gt;                       &lt;dbl&gt; &lt;chr&gt;
##  1 Santa Catarina    China 2019 - Valor FOB (US$) 1589499886 2019 
##  2 Santa Catarina    China 2018 - Valor FOB (US$) 3508475541 2018 
##  3 Santa Catarina    China 2017 - Valor FOB (US$) 1387040317 2017 
##  4 Santa Catarina    China 2016 - Valor FOB (US$) 1096838348 2016 
##  5 Santa Catarina    China 2015 - Valor FOB (US$)  829695943 2015 
##  6 Santa Catarina    China 2014 - Valor FOB (US$) 1149980960 2014 
##  7 Santa Catarina    China 2013 - Valor FOB (US$)  999306427 2013 
##  8 Santa Catarina    China 2012 - Valor FOB (US$)  900878336 2012 
##  9 Santa Catarina    China 2011 - Valor FOB (US$)  706020312 2011 
## 10 Santa Catarina    China 2010 - Valor FOB (US$)  427097677 2010 
## # … with 2,310 more rows</code></pre>
<div id="criando-novas-colunas-com-base-em-colunas-existentes" class="section level3">
<h3>Criando novas colunas com base em colunas existentes</h3>
<p>Para finalizarmos o limpeza do banco de exportação para que fique pronto para criarmos o gráfico ainda precisamos fazer algumas pequenas alterações. Veja que os valores das exportações como aparecem são difíceis de ler pois não existe pontuação ou dígitos que nos indiquem centenas e milhares. Para que a leitura dos valores ficasse mais compreensível nos gráficos do dashboard transformei os valores em milhões simplesmente dividindo os valores da coluna <code>valor</code> por um milhão. Para fazer este cálculo retornamos ao pacote <code>dplyr</code> para utilizar a função <code>mutate</code> que nos permite realizar cálculos e gerar novas colunas a partir de valores de colunas já existentes. Logo após a função <code>mutate</code>, entre parênteses, damos o nome à nova variável (que no nosso exemplo será <code>valor_milhoes</code>), seguido de <code>=</code> e o cálculo que queremos realizar (veja no código abaixo).</p>
<p>Além dessa alterção, precisamos filtrar apenas os países de interesse da coluna país. Faremos da mesma forma como apresentado no workshop anterior: criaremos um vetor com o nome dos países e o incluíremos na função filter com símbolo <code>%in%</code>. Por fim, vamos selecionar apenas as colunas que nos interessam, <code>País</code>, <code>valor</code> e <code>ano</code> e salvaremos todas as alterações no objeto <code>exportacao</code>. Por fim, utilizaremos mais uma função do <code>dplyr</code>, a <code>rename</code>, para alterar o nome da coluna <code>País</code> para <code>pais</code>, assim evitamos acentos em nossa programação. Faremos todas essas alterações em apenas um bloco de código</p>
<pre class="r"><code>#primeiro crio o vetor com os países que serão filtrados
paises&lt;-c(&quot;Alemanha&quot;, &quot;China&quot;, &quot;Estados Unidos&quot;, &quot;França&quot;, &quot;Itália&quot;, &quot;Japão&quot;,
          &quot;Reino Unido&quot;)


exportacao&lt;-exportacao%&gt;%
  mutate(valor_milhoes=valor/1000000)%&gt;%
  filter(País %in% paises)%&gt;%
  select(País, valor_milhoes, ano)%&gt;%
  rename(pais=País)
  
exportacao</code></pre>
<pre><code>## # A tibble: 70 x 3
##    pais  valor_milhoes ano  
##    &lt;chr&gt;         &lt;dbl&gt; &lt;chr&gt;
##  1 China         1589. 2019 
##  2 China         3508. 2018 
##  3 China         1387. 2017 
##  4 China         1097. 2016 
##  5 China          830. 2015 
##  6 China         1150. 2014 
##  7 China          999. 2013 
##  8 China          901. 2012 
##  9 China          706. 2011 
## 10 China          427. 2010 
## # … with 60 more rows</code></pre>
<p>Este será o banco que utilizaremos para criar nossos gráficos de exportação. Vamos salvá-los para não ter que rodar novamente todos esses códigos. Vou salvá-lo como csv com o nome de “exportacao_final”.</p>
<pre class="r"><code>write_csv(exportacao, &quot;dados/exportacao_final.csv&quot;)</code></pre>
</div>
</div>
<div id="transformando-tabela-long-para-wide-limpando-a-tabela-migracao_sexo" class="section level2">
<h2>Transformando tabela long para wide: limpando a tabela migracao_sexo</h2>
<p>Agora vamos fazer algumas alterações na tabela <code>migracao_sexo</code> que foi criada nas atividades do workshop 2. Para criarmos um gráfico do tipo dumbbell como o apresentado no dashboard precisamos que a tabela apresente o nome dos países e os valores de entrada no estado por sexo nas colunas. Para isso, utilizaremos a função do <code>tidyr</code> chamada <code>pivot_wider</code>. Ela receberá os seguintes argumentos:</p>
<ul>
<li><p><code>names_from</code> = deve receber a coluna que deve ser reestruturada de long para wide. Queremos ter uma coluna para valores de Feminino e outra para Masculino, assim esse argumento receberá a coluna que nos diz o sexo, que é <code>SEXO_DESCRICAO</code>.</p></li>
<li><p><code>values_from</code> = deve receber a coluna com os valores que as novas colunas devem receber. No nosso caso é <code>total_sexo</code>.</p></li>
</ul>
<p>Vou salvar os resultados no próprio objeto <code>migracao_sexo</code>, subscrevendo a tabela anterior.</p>
<pre class="r"><code>migracao_sexo&lt;-migracao_sexo%&gt;%
  pivot_wider(names_from = SEXO_DESCRICAO, values_from = total_sexo)

migracao_sexo</code></pre>
<pre><code>## # A tibble: 7 x 3
##   PNASC_DESC                 Feminino Masculino
##   &lt;chr&gt;                         &lt;dbl&gt;     &lt;dbl&gt;
## 1 ALEMANHA                        412       583
## 2 ESTADOS UNIDOS DA AMERICA       424       574
## 3 FRANCA                          191       269
## 4 ITALIA                          165       400
## 5 JAPAO                            27        39
## 6 REINO UNIDO                      10        19
## 7 REPUBLICA POPULAR DA CHINA       67       137</code></pre>
<p>Para finalizarmos esse banco ainda precisamos alterar a forma como estão escritos os nomes dos países. Repare que neste banco os nomes estão escritos de forma completamente diferente do banco de exportação. Vamos uniformizar esses nomes. Para isso vamos usar a função <code>mutate</code> para criar uma nova coluna a partir da coluna <code>PNASC_DESC</code> que se chamará <code>paises</code>. Dentro de <code>mutate</code> vamos utilizar outra função do dplyr chamada <code>case_when</code> que nos permite recodificar os casos. Assim, diremos ao <code>dplyr</code> que toda vez (<code>case_when</code>) a coluna <code>PNASC_DESC</code> for igual (<code>==</code>) à <code>&quot;REPUBLICA POPULAR DA CHINA&quot;</code> queremos que a nova coluna <code>paises</code> receba como valor (<code>~</code>) <code>China</code>. Faremos isso com todos os países. Salvarei as alterações no mesmo objeto migracao_sexo. Veja abaixo como fica a sintaxe.</p>
<pre class="r"><code>migracao_sexo&lt;-migracao_sexo%&gt;%
  mutate(paises=case_when(PNASC_DESC==&quot;REPUBLICA POPULAR DA CHINA&quot; ~ &quot;China&quot;,
                          PNASC_DESC==&quot;REINO UNIDO&quot; ~ &quot;Reino Unido&quot;,
                          PNASC_DESC==&quot;JAPAO&quot; ~ &quot;Japão&quot;,
                          PNASC_DESC==&quot;ITALIA&quot; ~ &quot;Itália&quot;,
                          PNASC_DESC==&quot;FRANCA&quot; ~ &quot;França&quot;,
                          PNASC_DESC==&quot;ESTADOS UNIDOS DA AMERICA&quot; ~ &quot;Estados Unidos&quot;,
                          PNASC_DESC==&quot;ALEMANHA&quot; ~ &quot;Alemanha&quot;))

migracao_sexo</code></pre>
<pre><code>## # A tibble: 7 x 4
##   PNASC_DESC                 Feminino Masculino paises        
##   &lt;chr&gt;                         &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;         
## 1 ALEMANHA                        412       583 Alemanha      
## 2 ESTADOS UNIDOS DA AMERICA       424       574 Estados Unidos
## 3 FRANCA                          191       269 França        
## 4 ITALIA                          165       400 Itália        
## 5 JAPAO                            27        39 Japão         
## 6 REINO UNIDO                      10        19 Reino Unido   
## 7 REPUBLICA POPULAR DA CHINA       67       137 China</code></pre>
<p>Vamos salvar este banco como csv com o nome de <code>migracao_sexo_final</code>.</p>
<pre class="r"><code>write_csv(migracao_sexo, &quot;dados/migracao_sexo_final.csv&quot;)</code></pre>
</div>
<div id="visualização-de-dados-com-ggplot2" class="section level2">
<h2>Visualização de dados com ggplot2</h2>
<p>Agora que já temos nossos dados limpos e estruturados podemos pensar em elaborar gráficos com eles. Podemos elaborar gráficos apenas com a base do R, porém, existe um pacote ainda mais poderoso para elaboração de gráficos: o ggplot2. Apesar de ser mais complexo com relação à sintaxe do código, o ggplot2 permite elaborar gráficos altamente customizáveis e, como resultado, entrega visualizações de dados bem mais profissionais. Desta forma, vamos focar o restante deste workshop em compreender a sintaxe do ggplot2 e como customizar nossos gráficos com esse pacote.</p>
<div id="a-gramática-em-camadas-do-ggplot2" class="section level3">
<h3>A gramática em camadas do ggplot2</h3>
<p>O ggplot2, como dito anteriormente, é um pacote para visualização de dados e, assim como o <code>dplyr</code> e o <code>tidyr</code>, faz parte do <code>tidyverse</code>. Ele segue uma sintaxe que chamamos de “gramática de gráficos” em que o gráfico é contruído de camada em camada. O bloco de código abaixo apresenta conceitualmente a estrutura básica das camadas para se construir um gráfico. Camadas adicionais podem ser adicionadas para customizar o gráfico.</p>
<pre class="r"><code>ggplot(data = &lt;NOME_DO_BANCO&gt;, mapping = aes(&lt;MAPEAMENTO&gt;) ) +
  &lt;GEOM_FUNCTION&gt;(
    stat = &lt;ESTATISTICA&gt;,
    position= &lt;POSICAO&gt;) +
  &lt;COORDINATE_FUNCTION&gt; +
  &lt;FACET_FUNCTION&gt;
  )</code></pre>
<p>Vamos entender essa sintaxe:</p>
<ol style="list-style-type: decimal">
<li><p>Primeiro começamos o bloco de código chamando a função <code>ggplot</code>. Então abrimos parênteses para começar a escrever nossa primeira camada. O primeiro argumento dessa função é o banco de dados que utilizaremos para criar o gráfico, seguido de vírgula. Após a vírgula, vamos realizar o mapeamento do gráfico com o argumento <code>aes</code> (de aesthetics, estética em ingês). Aqui nós iremos indicar quais colunas do nosso banco devem entrar no eixo x e no eixo y. Essa é a nossa primeira camada. Para adicionar uma segunda camada digitamos <code>+</code> ao final desta camada.</p></li>
<li><p>A segunda camada começa com a função que indica o tipo de gráfico que iremos montar. A função sempre começa com <code>geom_</code> que indica a “geometria” ou o desenho do gráfico. Por exemplo, se for um gráfico de barras a função será <code>geom_bar</code>, se for de linha <code>geom_line</code>, se for um gráfico de dispersão, em que cada observação da tabela será um ponto no gráfico, utilizaremos <code>geom_point</code>. Existem diversas geometrias para o gráfico, mas em nosso workshop vamos focar em gráficos de linha e de barras pois são os que melhor apresentam os dados que estamos trabalhando. Para conhecer as outras possibilidades de gráficos veja a documentação do ggplot2 e os tutoriais que inclui no material complementar.</p></li>
</ol>
<p>Logo após a função <code>geom_</code>, dentro dos parênteses temos o argumento stat, que indica a estatística que será utilizada sobre os dados. Nem sempre este argumento é utilizado. Podemos utilizar neste argumento a média, proporção, etc. No caso dos nossos dados queremos que o gráfico apresente extamante os números observados na tabela, por isso usamos como argumento, principalmente em gráficos de barra, “identity”.</p>
<p>O próximo argumento desta camada é a posição da nossa geometria. Nem sempre ela será necessária também. Com ela podemos indicar, por exemplo, se queremos o nosso gráfico de barras agrupados um do lado do outro (<code>dodge</code>), ou todas as categorias de uma variável na mesma barra (<code>stacked</code>), etc. Ao finalizar essa camada seguimos para a seguinte com <code>+</code></p>
<ol start="3" style="list-style-type: decimal">
<li><p>A próxima camada indica o sistema de coordenadas do gráfico. O sistema default do <code>ggplot2</code> é o sistema cartesiano, mas existem vários outros sistemas de coordenadas possíveis. Nesse curso vamos trabalhar apenas com o sistema cartesiano, possívelmente apenas alterando as posições de x e y para termos outras possibilidades de visualização por meio da função <code>coord_flip()</code></p></li>
<li><p>A última camada apresentada no código acima (que não necessariamente será a última camada do gráfico) é uma camada opcional chamada <code>facet</code>. Esta camada permite dividir o seu gráfico em subgráficos, cada um deles apresentando um subconjunto dos dados. Essa é uma função particularmente útil quando queremos elaborar visualizações para variáveis com várias categorias.</p></li>
</ol>
<p>Neste workshop vamos focar nas duas primeiras camadas que nos permitem construir o corpo do gráfico. No workshop 4 veremos como customizar nossos gráficos, então veremos as últimas duas camadas, além de camadas complementares que nos permitem alterar cor, incluir título, alterar fundo, etc.</p>
<p>Vamos ver na prática como essas camadas são construídas. Vamos utilizar o banco <code>migracao_sexo</code> elaborado na atividade 2 para criar um gráfico de barras apresentando o total de migrantes alemães que entraram em Santa Catarina por ano.</p>
<pre class="r"><code>ggplot(migracao_alemanha, aes(x=ano, y=total))+
  geom_bar(stat = &quot;identity&quot;)</code></pre>
<p><img src="workshop3_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>Veja que para chegar a este gráfico construímos 2 camadas. Começamos usando a função <code>ggplot</code>, incluindo o nome do banco a ser utilizado, seguido de vírgula e o argumento <code>aes</code> em que dizemos ao ggplot qual variável entra no eixo x e qual entra no eixo y. Queremos que x sejam os anos e y o total de migrantes. Finalizamos essa camada com o <code>+</code> para incluir a segunda camada. Na segunda camada indicamos que queremos um gráfico de barras com a função geom_bar, e entre parênteses usamos o argumento <code>stat=&quot;identity</code> para indicar ao ggplot que queremos que as barras representem exatamente o valor indicado na tabela.</p>
<p>Mas existe um problema no eixo x: os anos estão aparecendo com decimais. Isso tem a ver com a discussão do workshop passado sobre tipos de dados. Vamos usar a função <code>glimpse</code> para verificar como estão armazenados esses dados.</p>
<pre class="r"><code>glimpse(migracao_alemanha)</code></pre>
<pre><code>## Rows: 10
## Columns: 2
## $ ano   &lt;dbl&gt; 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019
## $ total &lt;dbl&gt; 50, 68, 54, 120, 104, 129, 153, 122, 98, 97</code></pre>
<p>Repare que o ano está como um valor numérico que aceita dígitos (double). Como discutimos na semana passada, nossa variável de ano deve ser um fator, pois não é uma quantidade e sim um tipo de categoria. Vamos realizar a alteração de numérico para fator, como vimos no workshop passado, e rodar novamente o código para criar o gráfico.</p>
<pre class="r"><code>migracao_alemanha$ano&lt;-as.factor(migracao_alemanha$ano)

ggplot(migracao_alemanha, aes(x=ano, y=total))+
  geom_bar(stat = &quot;identity&quot;)</code></pre>
<p><img src="workshop3_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>Veja que após a alteração do tipo de dado o gráfico apresenta um ano para cada barra. No próximo workshop veremos como customizar esse gráfico, alterando cores, mudando label dos eixos, incluindo título, etc.</p>
<p>Agora vamos trabalhar com nosso banco de exportação. Digamos que queremos criar um gráfico de barras com os valores de exportação para a China. No caso do nosso banco <code>migracao_alemanha</code> já tínhamos o banco recortado apenas com dados da Alemanha. No caso do banco de exportação podemos utilizar o <code>dplyr</code> para filtrar apenas a China e utilizar o ggplot para plotar o gráfico logo depois no mesmo bloco de gráficos utilizando o <code>%&gt;%</code>. Repare que como estamos utilizando a função <code>ggplot</code> seguido de um <code>%&gt;%</code> não é necessário colocar o nome do banco utilizado como argumento pois já especificamos no começo do bloco de código, na primeira linha.</p>
<pre class="r"><code>exportacao%&gt;%
  filter(pais==&quot;China&quot;)%&gt;%
  ggplot(aes(x=ano, y=valor_milhoes))+
  geom_bar(stat=&quot;identity&quot;)</code></pre>
<p><img src="workshop3_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p>Vamos explorar um pouco mais o gráfico de barras. Digamos que queremos ver a evolução das exportação de todos os países para todos os anos. Cada ano apresentaria uma barra com os valores de cada país. Para isso, na primeira camada teremos que indicar no argumento <code>aes</code> (lembre-se que é ele que criar a “estética” do gráfico) que cada barra representará um país. Para isso utilizamos o argumento <code>fill</code>. Na camada que cria a geometria do gráfico, utilizaremos o argumento <code>position</code> dentro da função <code>geom_bar</code> como apresentado no bloco de códigos conceitual acima. Em <code>position</code> queremos indicar ao ggplot que queremos as barras agrupadas, então utilizamos o argumento <code>position_dodge()</code></p>
<pre class="r"><code>exportacao%&gt;%
  ggplot(aes(x=ano, y=valor_milhoes, fill=pais))+
  geom_bar(stat=&quot;identity&quot;, position=position_dodge())</code></pre>
<p><img src="workshop3_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p>Repare, no entanto, que esse gráfico não é muito legível. Ele está muito tulmutuado, com muitas barras. Uma alternativa, se quisessemos insistir no gráfico de barras, seria utilizar a camada de <code>facet</code> (camada 4 do nosso bloco de código conceitual acima) e retirar os argumentos <code>fill</code> e <code>position</code> da primeira e segunda camada. Faríamos um facet por país, que geraria um gráfico com 7 subgráficos, um para cada país. Veremos como fazer isso no próximo workshop.</p>
<p>Uma segunda opção seria plotar um gráfico de linha como temos em nosso dashboard. Para isso, ao invés de utilizarmos o <code>geom_bar</code> na segunda camada utilizaremos a função <code>geom_line</code>. Na primeira camada, além dos argumentos referentes aos eixos, teremos que colocar mais dois: o <code>group</code> e o <code>colour</code>. O argumento <code>group</code> indica ao ggplot sobre o quê se refere cada linha do gráfico, que no nosso caso são os países. O argumento <code>colour</code> indica ao ggplot que cada país terá cores diferentes.</p>
<pre class="r"><code>exportacao%&gt;%
  ggplot(aes(x=ano, y=valor_milhoes, group=pais, colour=pais))+
  geom_line()</code></pre>
<p><img src="workshop3_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>Gráficos também podem ser salvos dentro de objetos. Pode ser útil salvá-los ao longo de um projeto para não ter que ficar rodando repetidamente o mesmo bloco de código para gerar o gráfico.</p>
<pre class="r"><code>plot_exportacao&lt;-exportacao%&gt;%
  ggplot(aes(x=ano, y=valor_milhoes, group=pais, colour=pais))+
  geom_line()

plot_exportacao</code></pre>
<p><img src="workshop3_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
</div>
<div id="salvando-gráficos-do-ggplot2" class="section level3">
<h3>Salvando gráficos do ggplot2</h3>
<p>Podemos salvar nossos gráficos por meio do próprio R Studio. Nas imagens a seguir mostro o passo a passo.</p>
<ol style="list-style-type: decimal">
<li>No painel da direita, na parte de baixo, selecione a aba “Plots”. O gráfico que quer salvar deve estar aparecendo neste painel. Se não estiver, rode o bloco de códigos com o gráfico que quer salvar. No pequeno menu deste painel clique em “Export”.</li>
</ol>
<p><img src="imagens/plot1.png" /></p>
<p>É possível salvar um gráfico como pdf ou imagem. Vamos salvá-la como imagem. Escolha a opção “Save as Image”.</p>
<p><img src="imagens/plot2.png" /></p>
<p>A tela a seguir abrirá para você.</p>
<p><img src="imagens/plot3.png" /></p>
<p>No canto superior esquerdo, em “Image Format”, é possível selecionar o formato como quer salvar seu gráfico, incluindo PNG e JPEG.</p>
<p><img src="imagens/plot4.png" /></p>
<p>Em “File name” escreva o nome que quer que seu arquivo salvo tenha. Repare ao lado de “Directory” que o seu gráfico será salvo na pasta que você apontou o R.</p>
<p><img src="imagens/plot5.png" /></p>
<p>No canto superior direito você pode escolher as dimensões que seu gráfico terá. Após realizar alterações clique no botão “Update Preview” para ver as modificações. Caso selecione a opção “Maintain aspect ratio” o RStudio adequará as dimensões do seu gráfico às proporções da tela.</p>
<p><img src="imagens/plot6.png" /></p>
<p>Se selecionar a opção “View plot after saving” no canto inferior esquerdo o R abrirá o documento com a sua imagem logo após ele for salvo.</p>
<p><img src="imagens/plot7.png" /></p>
<p>Após realizar todas as seleções não esqueça de clicar no botão “Save” para salvar seu gráfico. Ele estará no diretório de trabalho apontado para o R com <code>setwd()</code> no início do seu projeto.</p>
<p><img src="imagens/plot8.png" /></p>
</div>
</div>
</div>
<div id="atividades" class="section level1">
<h1>Atividades</h1>
<p>No próximo workshop continuaremos a explorar o ggplot2. Tratamos muitas informações em pouco tempo e, tendo em vista a complexidade do ggplot2, sugiro que aproveite o espaço de tempo maior entre este workshop e o próximo para revisar todo o material, fazer as atividades caso não tenha tido oportunidade, tirar dúvidas com nossa monitora e rever os videos dos workshops caso ache necessário. É importante que tenha entendido tudo o que foi visto até agora. O próximo workshop será ainda mais complexo quanto à sintaxe dos códigos e você poderá ficar perdido se não tiver compreendido o que vimos até agora.</p>
<p>Além de revisar o material, tenha uma seção de R iniciada no para o começo do próximo workshop. Nesta seção você deve ter:</p>
<ol style="list-style-type: decimal">
<li><p>O R apontado para o seu diretório de trabalho</p></li>
<li><p>Ter feito o upload do <code>tidyverse</code></p></li>
<li><p>Ter feito o upload das seguintes tabelas e salvado nos seguintes objetos:</p></li>
</ol>
<ul>
<li><code>migracao_alemanha.csv</code> (criada na atividade 2) em objeto com nome de <code>migracao_alemanha</code></li>
<li><code>exportacao_final.csv</code> (criada no workshop de hoje) em objeto com nome de <code>exportacao</code></li>
<li><code>migracao_sexo_final.csv</code> (criada no workshop de hoje) em objeto com nome de <code>migracao_sexo_wide</code></li>
</ul>
</div>
<div id="material-complementar" class="section level1">
<h1>Material complementar</h1>
<p>Para mais explicações sobre limpeza de banco de dados com <code>dplyr</code> e <code>tidy</code> leia <a href="https://datacarpentry.org/r-socialsci/03-dplyr-tidyr/index.html">essa aula do curso de R para Cientistas Sociais do Data Carpentries</a></p>
<p>Para explicação mais detalhada sobre visualização de dados com ggplot2 e a sua gramática veja <a href="https://r4ds.had.co.nz/data-visualisation.html">este capítulo do livro R for Data Science</a> e <a href="https://datacarpentry.org/r-socialsci/04-ggplot2/index.html">leia esta aula do curso de R para Cientistas Sociais do Data Carpentries</a></p>
<p>Você encontra todos os parâmetros para criar qualquer gráfico no ggplot2 na <a href="https://cran.r-project.org/web/packages/ggplot2/ggplot2.pdf">documentação oficial</a></p>
<p><a href="http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html#Time%20Series%20Plot%20From%20a%20Time%20Series%20Object">Aqui</a> você encontra tutoriais com códigos para criar vários tipos de gráficos no ggplot2.</p>
<p><a href="https://www.r-graph-gallery.com/index.html">Aqui</a> também tem uma lista de como fazer vários tipos de gráficos no ggplot2 com os respectivos códigos.</p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
